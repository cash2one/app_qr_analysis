## -*- coding: utf-8 -*-
<%inherit file="index_base.html"/>
<%block name="css">
<link rel="stylesheet" href="${STATIC_URL}css/uploadify/uploadify.css?v=3"/>
<link rel="stylesheet" href="${STATIC_URL}css/bootstrap-datetimepicker.css">
</%block>
<%block name="content">
<ol class="breadcrumb">
  <li><a href="/index">首页</a></li>
  <li class="active">编辑图片</li>
</ol>
<div class="container-pic" style="">
    <div class="pre-view">
        <div class="">
            <div class="pre-title">
                推广活动
            </div>
            <div class="pre-pic">
                <img id="cover" data-root="" src="${STATIC_URL}images/no_pic.png"
                     alt="预览图片">
            </div>
            <div class="pre-summary">
                概要信息
            </div>
        </div>
    </div>
    <div class="edit-area">
        <form id="edit">
            <input type="hidden" value="" name="cover">

            <div class="form-group">
                <div>标题</div>
                <input name="title" style="width: 80%;"/>
            </div>


            <div class="form-group">
                <div>作者</div>
                <input name="author" style="width: 80%;"/>
            </div>

            <div class="form-group">
                <div>封面</div>
                <input type="file" name="file" id="file_upload"/>
            </div>

            <div class="form-group">
                开始时间
                <div class='input-group date' id='start_time' style="width: 80%">
                <input class="form-control" type="text"  name="start_time"/> <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                </div>
            </div>

             <div class="form-group">
                结束时间
                <div class='input-group date' id='end_time' style="width: 80%">
                <input class="form-control" type="text"  name="end_time"/> <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                </div>
            </div>

            <div class="form-group">
                <div>摘要</div>
                <textarea name="summary" id="summary" rows="5" style="width: 80%;"></textarea>
            </div>

            <div class="form-group">
                <div>正文</div>
                <!--<textarea id="editor_id" name="none"></textarea>-->
                <script id="editor" type="text/plain" style="height:500px;"></script>
            </div>
        </form>
    </div>
    <div class="clear"></div>
    <div style="width: 100px;margin: 0 auto">
        <button id="commit" class="btn btn-success" style="width: 100px;">保存</button>
    </div>
</div>
</%block>

<%block name="js">
    <!--<script type="text/javascript" charset="utf-8" src="${STATIC_URL}js/editor/kindeditor-min.js"></script>
    <script type="text/javascript" charset="utf-8" src="${STATIC_URL}js/editor/lang/zh_CN.js"></script>-->
    <script type="text/javascript" src="${STATIC_URL}js/ueditor/ueditor.config.js?v=6"></script>
    <script type="text/javascript" src="${STATIC_URL}js/ueditor/editor_api.js?v=2"></script>
    <script type="text/javascript" charset="utf-8" src="${STATIC_URL}js/ueditor/lang/zh-cn/zh-cn.js"></script>

    <script type="text/javascript" src="${STATIC_URL}js/uploadify/jquery.uploadify.min.js"></script>
    <script type="text/javascript" src="${STATIC_URL}js/vendor/moment.js"></script>
    <script type="text/javascript" src="${STATIC_URL}js/vendor/zh-cn.js"></script>
    <script type="text/javascript" src="${STATIC_URL}js/vendor/bootstrap-datetimepicker.js"></script>
    <script>
        $(function(){
            $(window).bind('beforeunload',function(){
                var content = UE.getEditor('editor').getContent();
                localStorage.setItem('new_pic', content);
                return '以保存草稿 时间:'+new Date();
            });

            var content = localStorage.getItem('new_pic');
            setTimeout(function(){
                UE.getEditor('editor').setContent(content);
            }, 1000);


            var ue = UE.getEditor('editor',{
                imageActionName: '/editupload',
                imageFieldName: 'imgFile',
                imageUrlPrefix:'/static/upload/editor/',
                imageAllowFiles: [".png", ".jpg", ".jpeg", ".gif", ".bmp"]
            });

            $("#start_time").datetimepicker({
                format:'YYYY-MM-DD HH:mm:ss'
            });

            $("#end_time").datetimepicker({
                format:'YYYY-MM-DD HH:mm:ss'
            });

            $("#commit").click(function(){
            var title = $("input[name=title]").val();
            var author = $("input[name=author]").val();
            var cover = $("input[name=cover]").val();
            var summary = $("textarea[name=summary]").val();
            var content = UE.getEditor('editor').getContent();
            var start_time = $("input[name=start_time]").val();
            var end_time = $("input[name=end_time]").val();
            if(end_time.length == 0){
                alert("请输入结束时间");
                return false;
            }

            if(start_time.length == 0){
                alert("请输入开始时间");
                return false;
            }

            if(title.length == 0){
                alert("请输入标题");
                return false;
            }
            if(cover.length == 0){
                alert("请输入作者");
                return false;
            }
            if(summary.length == 0){
                alert("请输入作者");
                return false;
            }
            if(content.length == 0){
                alert("请输入正文内容");
                return false;
            }
            var post_data = $("#edit").serialize();
            post_data = post_data+"&content="+encodeURIComponent(content);
            $.ajax({
                type: "POST",
                url: "/picmsg/add",
                data: post_data,
                dataType: "json",
                success: function(json){
                    if(json.success){
                            window.location.href='/index';
                        }else{
                            alert(json.msg);
                        }
                },
                error: function(json){
                    alert(json.msg);
                }
            });

        });

        $("input[name=title]").keyup(function () {
            $(".pre-title").html($(this).val());
        });

        $("#summary").keyup(function () {
            $(".pre-summary").html($(this).val());
        });

            /*KindEditor.ready(function (K) {
                var options = {
                    height: '500px',
                    themeType: 'simple',
                    resizeType: 0,
                    uploadJson: '/editupload',
                    filterMode: false

                };
                window.meditor = K.create('#editor_id', options);
            });*/

            setTimeout(function () {
                $('#file_upload').uploadify({
                    'swf': '/static/js/uploadify/uploadify.swf',
                    'uploader': '/upload',
                    'buttonText': '上传图片',
                    'onUploadSuccess': function (file, data, response) {
                        var res = JSON.parse(data);
                        if (res.success) {
                            var img = res.msg.url;
                            $("input[name=cover]").val(img);
                            $("#cover").attr('src', img);
                        }
                    }
                });
            }, 50);
        });
    </script>
</%block>