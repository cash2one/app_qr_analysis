## -*- coding: utf-8 -*-
<!DOCTYPE html>
<html ng-app="myApp">
<head lang="en">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="${STATIC_URL}css/bootstrap.css"/>
    <link rel="stylesheet" href="${STATIC_URL}css/style.css"/>
    <link rel="stylesheet" href="${STATIC_URL}css/angular-wizard.css"/>
    <link rel="stylesheet" href="${STATIC_URL}css/uploadify/uploadify.css?v=3"/>
    <script src="${STATIC_URL}js/vendor/jquery-1.11.2.js" type="text/javascript"></script>
    <script src="${STATIC_URL}js/vendor/lodash.js"></script>
    <script src="${STATIC_URL}js/vendor/bootstrap.js" type="text/javascript"></script>
    <script type="text/javascript" src="${STATIC_URL}js/uploadify/jquery.uploadify.min.js"></script>
    <script src="${STATIC_URL}js/vendor/angular.js"></script>
    <script src="${STATIC_URL}js/vendor/angular-wizard.js"></script>


    <title>郁金香运动</title>
    <style>
        .item {
            display: inline-block;
            width: 100px;
            height: 36px;
            line-height: 36px;
            text-align: center;
            background: #EEE;
            margin-left: 10px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .item:hover {
            background: #F0F0E0;
        }

        .selected {
            border: 2px solid #FF6633;
            color: #FF6633;
        }

        .other {
            border: 1px solid #CCCCCC;
        }

        .edit{
            background: #EEE;
            width: 70%;
            margin: 0 auto;
            padding: 10px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                    aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/index">郁金香内容发布</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li><a href="#">Dashboard</a></li>
                <li><a href="#">Settings</a></li>
                <li><a href="#">Profile</a></li>
                <li><a href="javascript:void(0);" id="dropdownMenu1" data-toggle="dropdown" aria-expanded="true">设置</a>
                    <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="/logout">登出</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Another action</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Something else here</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Separated link</a></li>
                    </ul>
                </li>
            </ul>
            <form class="navbar-form navbar-right">
                <input type="text" class="form-control" placeholder="Search...">
            </form>
        </div>
    </div>
</nav>
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-3 col-md-2 sidebar">
            <ul class="nav nav-sidebar">
                <li class="${menu['pic']}"><a href="/index">素材管理<span class="sr-only">(current)</span></a></li>
                <li class="${menu['Reports']}"><a href="/equipment/list">跑鞋管理</a></li>
                <li class="${menu['Analytics']}"><a href="#">Analytics</a></li>
                <li class="${menu['Export']}"><a href="#">Export</a></li>
            </ul>
        </div>

        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
            <ol class="breadcrumb">
                <li><a href="/index">首页</a></li>
                <li class="active">添加装备</li>
            </ol>
            <div ng-controller="wizard">
                <wizard on-finish="finishedWizard()">
                    <wz-step title="选择类别">
                        <item ng-repeat="i in categories" id={{i.id}}></item>
                        <div class="item other" ng-click="selectOther()">其他</div>
                        <div ng-show="hide" style="width: 50%;padding: 10px;background: #EEE;margin: 4px auto">
                            <form class="form-horizontal">
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">类别名</label>

                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" ng-model="data.cateName">
                                    </div>
                                </div>
                            </form>
                            <button type="button" class="btn btn-success" ng-click="saveCategory()">保存</button>
                            <button type="button" class="btn btn-default" ng-click="cancelCreate()">取消</button>
                        </div>
                        <!--<h1>This is the first step</h1>-->

                        <!--<p>Here you can use whatever you want. You can use other directives, binding, etc.</p>-->
                        <div style="width: 80px;margin: 20px auto;">
                            <button type="button" class="btn btn-success" ng-click="goToSep1()">下一步</button>
                        </div>
                    </wz-step>

                    <wz-step title="选择品牌">
                        <item ng-repeat="i in brands" brand-id={{i.id}}></item>
                        <div class="item other" ng-click="selectBrandOther()">其他</div>
                        <div ng-show="brandHide" style="width: 50%;padding: 10px;background: #EEE;margin: 4px auto">
                            <form class="form-horizontal">
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">品牌名</label>

                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" ng-model="data.brandName">
                                    </div>
                                </div>
                            </form>
                            <button type="button" class="btn btn-success" ng-click="saveBrand()">保存</button>
                            <button type="button" class="btn btn-default" ng-click="cancelBrand()">取消</button>
                        </div>

                        <div style="width: 146px;margin: 20px auto;">

                            <button type="button" class="btn btn-primary" ng-click="backSep1()">上一步</button>
                            <button type="button" class="btn btn-success" ng-click="goToSep2()">下一步</button>
                        </div>

                    </wz-step>

                    <wz-step title="添加详情">
                        <div class="edit">
                            <form class="form-horizontal">
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">名字</label>

                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" ng-model="data.detail.shoeName">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-2 control-label">优点</label>

                                    <div class="col-sm-10">
                                        <textarea class="form-control" rows="3" ng-model="data.detail.shoePro"></textarea>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-2 control-label">缺点</label>

                                    <div class="col-sm-10">
                                        <textarea class="form-control" rows="3" ng-model="data.detail.shoeCon"></textarea>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-2 control-label">建议售价</label>

                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" ng-model="data.detail.shoeMsrp">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-2 control-label">标签</label>

                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" ng-model="data.detail.shoeTag">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-2 control-label">重量</label>

                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" ng-model="data.detail.shoeWeight">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-2 control-label">寿命</label>

                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" ng-model="data.detail.shoeLife">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-2 control-label">图片</label>
                                    <img src="{{data.detail.shoeImg}}" style="width: 50%">
                                    <div style="width: 80px;margin: 10px auto;">
                                        <div id="uploadifytest" class="btn btn-success" ng-model="image"
                                             snail-uploadify="{auto:false,buttonText:'图片上传'}">
                                            <img ng-show="image" ng-src="image" style="height: 80px;"/>
                                        </div>
                                    </div>
                                </div>

                                <button type="button" class="btn btn-success" ng-click="saveShoes()">保存</button>
                            </form>
                        </div>

                        <div style="width: 146px;margin: 20px auto;">

                            <button type="button" class="btn btn-primary" ng-click="backSep2()">上一步</button>
                            <button type="button" class="btn btn-success" wz-next>完成</button>
                        </div>
                    </wz-step>
                </wizard>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    var app = angular.module('myApp', ['mgo-angular-wizard']);

    app.directive("item", function () {
        return {
            restrict: 'E',
            template: "<div class='item'>{{ i.brand }}</div>",
            link: function ($scope, element, attr) {
                $(element).click(function () {
                    $(".item").each(function () {
                        $(this).removeClass("selected");
                    });

                    $(this).find(".item").addClass("selected");
                    if (attr.id) {
                        $scope.data.checkedCateId = attr.id;
                    }
                    if (attr.brandId) {
                        $scope.data.checkedBrandId = attr.brandId;
                    }

                });
            }
        }
    });

    app.directive("snailUploadify", function () {
        return {
            require: '?ngModel',
            restrict: 'A',
            link: function ($scope, element, attrs, ngModel) {
                var opts = angular.extend({}, $scope.$eval(attrs.nlUploadify));
                element.uploadify({
                    'fileObjName': opts.fileObjName || 'Filedata',
                    'auto': opts.auto != undefined ? opts.auto : true,
                    'swf': opts.swf || '/static/js/uploadify/uploadify.swf',
                    'uploader': opts.uploader || '/upload',//图片上传方法
                    'buttonText': opts.buttonText || '更换图片',
                    'width': opts.width || 80,
                    'height': opts.height || 25,
                    'onUploadSuccess': function (file, d, response) {
                        var result = eval("[" + d + "]")[0];
                        if (result.success) {
                            //$scope.shoeImg = result.msg.url;
                            $scope.$apply(function () {
                                console.log(result.msg.url);
                                $scope.data.detail.shoeImg = result.msg.url;
                            });
                        }
                    }
                });
            }
        };
    });

    app.controller("wizard", function ($scope, $http, WizardHandler, $log) {
        $scope.brandHide = false;
        $scope.data = {};
        $scope.data.detail = {};
        $scope.hide = false;
        $scope.data.detail.shoeImg = "${STATIC_URL}images/no_pic.png";
        $scope.categories = [{id: 1, brand: '跑鞋'}, {id: 2, brand: '表'}];
        $http.get("/api/v1/shoes/brands").success(function (response) {
            $scope.brands = response.msg;
        });

        $scope.goToSep1 = function () {
            if (!$scope.data.checkedCateId) {
                alert("请选择类别");
                return false;
            }
            WizardHandler.wizard().next();
        };

        $scope.goToSep2 = function () {
            $log.info($scope.data.checkedCateId + "----" + $scope.data.checkedBrandId);
            if(!$scope.data.checkedBrandId){
                alert("请选择品牌");
                return false;
            }
            WizardHandler.wizard().next();
        };

        $scope.backSep1 = function () {
            WizardHandler.wizard().previous();
        };


        $scope.finishedWizard = function () {
            WizardHandler.wizard().previous();
            WizardHandler.wizard().previous();
        };

        $scope.selectOther = function () {
            $scope.hide = true;
        };

        $scope.cancelCreate = function () {
            $scope.hide = false;
        };

        $scope.saveCategory = function () {
            $scope.categories.push({id: 3, name: $scope.data.cateName});
            $scope.hide = false;
        };

        $scope.selectBrandOther = function () {
            $scope.brandHide = true;
        };

        $scope.saveBrand = function () {
            $log.info($scope.data.brandName);
            $scope.brandHide = false;
            $http.post("/api/v1/shoes/brand/save", $scope.data).success(function (res) {
                if (res.success) {
                    var brand = {id: res.msg.id, brand: res.msg.brand};
                    $scope.brands.push(brand);
                }
            }).error(function () {
                alert("保存失败");
            });
        };

        $scope.cancelBrand = function () {
            $scope.brandHide = false;
        };

        $scope.backSep2 = function(){
             WizardHandler.wizard().previous();
        };

        $scope.saveShoes = function(){
            if(!$scope.data.detail.shoeName){
                alert("请输入名字");
                return false;
            }

            $http.post("/api/v1/shoes/save", $scope.data).success(function(res){
                if(res.success){
                    alert('添加成功');
                    WizardHandler.wizard().next();
                }
            });
        };

    });

</script>
</body>
</html>
